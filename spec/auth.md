# Authentication and Authorization

To invoke any API's mentioned in this specification a client must first acquire a token (and the url) to the server which serves these API's.

The Xet protocol server uses bearer authentication via a token generated by the huggingface hub (<https://huggingface.co>).

The following section explains how to acquire such a token.

## API Endpoints

### Direct Token Request

**URL Pattern:**

```txt
https://huggingface.co/api/{repo_type}s/{repo_id}/xet-{token_type}-token/{revision}
```

**Parameters:**

- `repo_type`: Type of repository - `model`, `dataset`, or `space`
- `repo_id`: Repository identifier in format `namespace/repo-name`
- `token_type`: Either `read` or `write`
- `revision`: Git revision (branch, tag, or commit hash; default to using `main`)

**Example URLs:**

```txt
https://huggingface.co/api/models/microsoft/DialoGPT-medium/xet-read-token/main
https://huggingface.co/api/datasets/squad/xet-write-token/v1.1
https://huggingface.co/api/spaces/huggingface/CodeBERTa/xet-read-token/main
```

**HTTP Method:** GET

**Required Headers:**

- `Authorization`: Bearer token for Huggingface Hub authentication

## Response Format

A JSON encoded object with the following format:

```typescript
{
   "accessToken": string,
   "exp": number,
   "casUrl": string,
}
```

- accessToken is the token to be used when invoking API's on the Xet CAS service (any Xet API denoted in this specification)
- exp is the unix timestamp of when this token expires
- casUrl is the API service endpoint URL

### Example Response Object

```json
{
   "accessToken": "xet_xxxxxxxxxxx",
   "exp": 1848535668,
   "casUrl": "https://cas-server.xethub.hf.co"
}
```

## Response Headers

The same information in the response JSON object is also included in the following headers:

- `X-Xet-Access-Token`: The access token for Xet service authentication
- `X-Xet-Token-Expiration`: Unix timestamp (as string) when the token expires
- `X-Xet-Cas-Url`: The Xet API service endpoint URL

### Example Response Headers

```txt
X-Xet-Access-Token: xet_token_abc123xyz789
X-Xet-Token-Expiration: 1698765432
X-Xet-Cas-Url: https://cas-server.xethub.hf.co
```

## Error Handling

### HTTP Errors

- **401 Unauthorized**: Invalid or missing Hub authentication token
- **403 Forbidden**: Insufficient permissions for the requested token type
- **404 Not Found**: Repository or revision does not exist

### Missing Headers

If the required Xet headers (`X-Xet-Cas-Url`, `X-Xet-Access-Token`, `X-Xet-Token-Expiration`) are not present in the response, the request should be considered failed.

## Implementation Example

Here's a basic implementation flow:

1. **Make the request:**

   ```http
   GET /api/models/microsoft/DialoGPT-medium/xet-read-token/main
   Host: huggingface.co
   Authorization: Bearer xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
   ```

2. **Parse the response (or headers):**

   ```python
   endpoint = response_json["casUrl"] # or response.headers['X-Xet-Cas-Url']
   access_token = response_json["accessToken"] # or response.headers['X-Xet-Access-Token'] 
   expiration = response_json["exp"] # or int(response.headers['X-Xet-Token-Expiration'])
   ```

3. **Use the token with Xet service:**
   Use Bearer authentication with the `access_token` to authenticate with the Xet service at `endpoint` until `expiration` time.

4. **Token refresh (when needed):**
   Use the same API to generate a new token

## Security Considerations

- Xet tokens are time-limited and should be refreshed/swapped before expiration
- Store tokens securely and avoid logging them
- Use read tokens when possible; only request write tokens when necessary
- The Hub authentication token (Bearer token) should be kept secure as it's used to obtain Xet tokens
